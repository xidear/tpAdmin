# 反向代理配置 - 转发API请求到Swoole服务
# 将此文件放在 /www/server/panel/vhost/nginx/proxy/admin.test.binary.ha.cn/ 目录下

# 转发API请求到Swoole服务
location ~ ^/(adminapi|api)/ {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    
    add_header X-Cache $upstream_cache_status;
    
    # 设置缓存
    set $static_file 0;
    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" ) {
        set $static_file 1;
        expires 1m;
    }
    if ( $static_file = 0 ) {
        add_header Cache-Control no-cache;
    }
}

# 转发其他动态请求到Swoole服务
location / {
    # 排除静态文件
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webmanifest|html|txt|xml|json)$ {
        try_files $uri =404;
    }
    
    # 排除admin目录（由主配置处理）
    location /admin/ {
        try_files $uri $uri/ /admin/index.html;
    }
    
    # 转发到Swoole服务
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    
    add_header X-Cache $upstream_cache_status;
    
    # 设置缓存
    set $static_file 0;
    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" ) {
        set $static_file 1;
        expires 1m;
    }
    if ( $static_file = 0 ) {
        add_header Cache-Control no-cache;
    }
}
